<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>家用灵车虚拟化技术指北</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
          <section>
            <h2 class="r-fit-text"><span style="color: red;">家</span><span style="color: green;">用</span><span style="color: orange;">灵</span><span style="color: blue;">车</span></h2>
            <h2 class="r-fit-text">虚拟化技术指北</h2>
            <img src="misaka.jpg" style="border-radius: 50%; width: 4em;"> 
          </section>
          <section>
            <ul>
              <li>硬件选择
                <p style="margin-left: 1em;">CPU、主板、内存、<del>GPU</del>空气</p>
              </li>
              <li>软件配置
                <p style="margin-left: 1em;">qemu、OVMF、声音、输入设备等</p>
              </li>
            </ul> 
          </section>
          <section>
            <h2>我的硬件配置</h2>
            <ul>
              <li>CPU
                <p style="margin-left: 1em;"><del><a href="https://www.amd.com/en/products/apu/amd-ryzen-5-2400g">AMD Ryzen™ 5 2400G</a></del></p>
                <p style="margin-left: 1em;"><a href="https://www.amd.com/en/products/cpu/amd-ryzen-7-3700x">AMD Ryzen™ 7 3700X</a></p>
              </li>
              <li>主板
                <p style="margin-left: 1em;"><del><a href="https://www.msi.com/Motherboard/B350M-MORTAR">MSI B350M MORTAR</a></del></p>
                <p style="margin-left: 1em;"><a href="https://www.asrock.com/mb/AMD/B550M%20Steel%20Legend">ASRock B550M Steel Legend</a></p>
              </li>
              <li>内存: <del>2x16GB 3200MHz</del> 2x32GB 3200MHz ECC</li>
              <li>GPU: <del>GTX 1050</del> GTX 1650 SUPER</li>
            </ul>
          </section>
          <section>
            <h2>LSI SAS 9300-8i HBA 卡</h2>
            <img class="r-stretch" src="https://images-na.ssl-images-amazon.com/images/I/51wT%2BGVry2L._AC_SX466_.jpg">
            <p>PCIe 3.0x8、~150 CNY</p>
          </section>
          <section>
            <img class="r-stretch" src="pc.jpg">
          </section>
          <section>
            <h2>我的软件配置</h2>
            <ul>
              <li>物理机: Debian 10、ZFS on LUKS、rtorrent、samba、syncthing</li>
              <li>虚拟机
                <ul>
                  <li>一个 Gentoo Linux 虚拟机</li>
                  <li>一个 Windows 虚拟机</li>
                </ul>
              </li>
            </ul>
          </section>
          <section>
            <h2>为何不使用双系统？</h2>
            <ul>
              <li>双系统切换需要重启
                <p style="margin-left: 1em;">需要解锁 LUKS、无法保持服务不中断运行</p>
              </li>
              <li>Windows 下难以使用 ZFS 和 LUKS</li>
            </ul>
          </section>
				</section>

        <section>
          <section>
            <h2>硬件选择</h2>
            <p>IOMMU+Hardware Virtualization</p>
          </section>
          <section>
            <h2>IOMMU</h2>
            <p>Input-Output Memory Management Unit</p>
            <img class="r-stretch" src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/MMU_and_IOMMU.svg/1024px-MMU_and_IOMMU.svg.png">
          </section>
          <section>
            <h2>CPU</h2>
            <ul>
              <li>需要支持 IOMMU 和 Hardware Virtualization</li>
              <li>IOMMU 的不同名字: Intel VT-d 和 AMD-Vi</li>
              <li>在 <code>/proc/cpuinfo</code> 中的 <code>flags</code>
                <ul>
                  <li><code>vmx</code> 代表支持 Intel VT-d</li>
                  <li><code>svm</code> 代表支持 AMD-Vi</li>
                </ul>
              </li>
              <li>新一点的硬件都支持</li>
            </ul>
          </section>
          <section>
            <h2>主板</h2>
            <ul>
              <li>需要支持 IOMMU</li>
              <li>新一点的硬件都支持</li>
              <li>可以在网络上提前搜索主板的 IOMMU Group 配置</li>
            </ul>
          </section>
          <section>
            <h2>ECC 内存？</h2>
            <ul>
              <li>需要 CPU 和主板都支持</li>
              <li>无核显或者有核显且带 PRO 的 AMD Ryzen™ CPU 均支持 ECC UDIMM 内存</li>
              <li>ASUS 和 ASRock 的 B550 和 X570 系列支持 ECC</li>
            </ul>
          </section>
          <section>
            <p>购买主板前建议去官网检查一下，例如可能对于频率还有额外的要求</p>
            <img class="r-stretch" src="https://www.asrock.com/mb/Memory/4xMatisse-3200-2667.png">
          </section>
          <section>
            <h2>它的确是工作的</h2>
            <img class="r-stretch" src="eccerror.jpg">
          </section>
          <section>
            <h2>Intel 和 ECC</h2>
            <p>立即购买 Intel® Core™ i3 processor</p>
            <p>ECC Memory Supported ‡: Yes</p>
            <p>支持 ECC UDIMM 内存</p>
          </section>
          <section>
            <h2>PCIE？</h2>
            <ul>
              <li>AMD 的 B{3,4,5}50 系列主板
                <ul>
                  <li>PCIe {3,4}.0x16 用于插 GPU</li>
                  <li>PCIe {3,4}.0x4 用于插 NVMe SSD</li>
                </ul>
              </li>
              <li>Intel 的 CPU 可能只有 16 条 PCIe 3.0 lanes
                <p style="margin-left: 1em;">但是也可能有 20 条</li>
              </li>
            </ul>
          </section>
          <section>
            <h2>PCIe Bifurcation？</h2>
            <ul>
              <li>可以将 PCIe x16 拆分成 x8+x8 甚至 x8+x4+x4</li>
              <li>可以用于满足灵车需求: 家用平台的双卡丹炉</li>
            </ul>
          </section>
          <section>
            <img class="r-stretch" src="https://images.anandtech.com/doci/14161/X570.png">
          </section>
          <section>
            <h2>能不能再给力一点</h2>
          </section>
          <section>
            <h2>能: PLX SWITCH</h2>
          </section>
          <section>
            <img class="r-stretch" src="https://qnam.smzdm.com/202003/10/5e670a55908f68467.jpg_e1080.jpg">
          </section>
          <section>
            <h2>NVIDIA GTX 690</h2>
            <img class="r-stretch" src="https://tpucdn.com/gpu-specs/images/c/361-pcb-front.jpg">
          </section>
          <section>
            <p>由于 PLX switch 过于企业级，这样的家用消费级主板应该还不存在</p>
          </section>
          <section>
            <h2>主板风扇？</h2>
            <img class="r-stretch" src="https://forum.level1techs.com/uploads/default/original/3X/8/0/80e80fb88eec7fdf5e89b74329988c275e64750e.jpeg">
            <p>Buy yourself a B550 please XD</p>
          </section>
          <section>
            <h2>GPU</h2>
          </section>
          <section>
            <h2>NVIDIA 的显卡几乎总是工作的</h2>
            <blockquote>
              Along with today's NVIDIA 465 series Linux beta an exciting shift at the company is they are now supporting accelerated GPU access by VMs with their GeForce consumer GPUs.
              <a href="https://www.phoronix.com/scan.php?page=news_item&px=NVIDIA-GeForce-Virt-On-Linux">来源</a>
            </blockquote>
            <p>支持“热插拔”</p>
          </section>
          <section>
            <h2>AMD GPU？</h2>
            <ul>
              <li>不支持“热插拔” <a href="https://github.com/gnif/vendor-reset">vendor-reset</a></li>
              <li>Linux 下的驱动质量一般</li>
              <li>但是对于 GPU passthrough 来说，应当也工作</li>
            </ul>
          </section>
        </section>

        <section>
          <section>
            <h2>软件配置</h2>
            推荐阅读 ArchWiki 的 <a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF">PCI passthrough via OVMF</a> 词条
          </section>
          <section>
            <h2>主板 BIOS 有关设置</h2>
            <ul>
              <li>需要在 BIOS 中开启硬件虚拟化支持和 IOMMU 支持</li>
              <li>具体设置方法和主板有关</li>
            </ul>
          </section>
          <section>
            <h2>HOST 配置</h2>
            <p>推荐使用 Debian</p>
          </section>
          <section>
            <h2>通过 GRUB 启用 Linux 的 IOMMU 支持</h2>
            <p>向 <code>/etc/default/grub</code> 中的 <code>GRUB_CMDLINE_LINUX</code> 添加选项</p>
            <ul>
              <li>AMD: <code>amd_iommu=on iommu=pt</code></li>
              <li>Intel: <code>intel_iommu=on iommu=pt</code></li>
            </ul>
            <p>更新 grub 配置并重启</p>
          </section>
          <section>
            <h2>检查 IOMMU Groups</h2>
            来自 <a href="https://wiki.archlinux.org/title/PCI_passthrough_via_OVMF#Isolating_the_GPU">ArchWiki</a>
            <pre><code><script type="text/template">#!/bin/bash
shopt -s nullglob
for g in `find /sys/kernel/iommu_groups/* -maxdepth 0 -type d | sort -V`; do
    echo "IOMMU Group ${g##*/}:"
    for d in $g/devices/*; do
        echo -e "\t$(lspci -nns ${d##*/})"
    done;
done;</script></code></pre>
          </section>
          <section>
            <h2>样例输出</h2>
            <pre style="font-size: 14pt; width: 100%;"><code><script type="text/template">IOMMU Group 2:
        00:03.0 Host bridge [0600]: Advanced Micro Devices, Inc. [AMD] Starship/Matisse PCIe Dummy Host Bridge [1022:1482]
        00:03.1 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Starship/Matisse GPP Bridge [1022:1483]
        06:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:2187] (rev a1)
        06:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:1aeb] (rev a1)
        06:00.2 USB controller [0c03]: NVIDIA Corporation Device [10de:1aec] (rev a1)
        06:00.3 Serial bus controller [0c80]: NVIDIA Corporation Device [10de:1aed] (rev a1)</script></code></pre>
          </section>
          <section>
            <pre style="font-size: 14pt; width: 100%;"><code><script type="text/template">IOMMU Group 0:
        00:01.0 Host bridge [0600]: Advanced Micro Devices, Inc. [AMD] Starship/Matisse PCIe Dummy Host Bridge [1022:1482]
        00:01.1 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Starship/Matisse GPP Bridge [1022:1483]
        00:01.2 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Starship/Matisse GPP Bridge [1022:1483]
        01:00.0 Non-Volatile memory controller [0108]: Sandisk Corp Device [15b7:5006]
        02:00.0 USB controller [0c03]: Advanced Micro Devices, Inc. [AMD] Device [1022:43ee]
        02:00.1 SATA controller [0106]: Advanced Micro Devices, Inc. [AMD] Device [1022:43eb]
        02:00.2 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Device [1022:43e9]
        03:00.0 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Device [1022:43ea]
        03:08.0 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Device [1022:43ea]
        04:00.0 Serial Attached SCSI controller [0107]: LSI Logic / Symbios Logic SAS2308 PCI-Express Fusion-MPT SAS-2 [1000:0087] (rev 05)
        05:00.0 Ethernet controller [0200]: Realtek Semiconductor Co., Ltd. Device [10ec:8125] (rev 05)</script></code></pre>
          </section>
          <section>
            <h2>配置 vfio-pci</h2>
            <ul>
              <li>向 <code>/etc/default/grub</code> 中的 <code>GRUB_CMDLINE_LINUX</code> 添加选项
                <pre><code><script type="text/template">vfio-pci.ids=10de:2187,10de:1aeb,10de:1aec,10de:1aed</script></code></pre>
              </li>
              <li>可能需要在 initramfs 中加载 <code>vfio-pci</code> 驱动
                <p>对于 Debian 系，向 <code>/etc/initramfs-tools/modules</code> 中添加
                  <pre><code><script type="text/template">vfio_pci
vfio
vfio_iommu_type1
vfio_virqfd</script></code></pre>
                  然后 <code>update-initramfs -u -k all</code> 并重启
                </p>
              </li>
            </ul>
          </section>
          <section>
            <h2>检查 vfio-pci 是否配置正确</h2>
            <p><code>lspci -kk</code></p>
            <pre><code><script type="text/template">06:00.0 VGA compatible controller: NVIDIA Corporation Device 2187 (rev a1)
        Subsystem: Gigabyte Technology Co., Ltd Device 401a
        Kernel driver in use: vfio-pci
        Kernel modules: nouveau
06:00.1 Audio device: NVIDIA Corporation Device 1aeb (rev a1)
        Subsystem: Gigabyte Technology Co., Ltd Device 401a
        Kernel driver in use: vfio-pci
        Kernel modules: snd_hda_intel</script></code></pre>
          </section>
          <section>
            <h2>配置虚拟机</h2>
          </section>
          <section>
            <p>安装 <code>qemu</code> 和 <code>ovmf</code> 后</p>
            <pre><code><script type="text/template">qemu-system-x86_64 \
        -machine q35,accel=kvm \
        -nographic -vga none -parallel none -serial none \
        -m $((48 * 1024)) \
        -cpu host,topoext,kvm=off,hv_relaxed,hv_spinlocks=0x1fff,hv_time,hv_vapic,hv_vendor_id=0xDEADBEEFFF \
        -rtc clock=host,base=localtime \
        -smp cores=8,threads=2,sockets=1 \
        -device vfio-pci,host=06:00.0 \
        -device vfio-pci,host=06:00.1 \
        -device vfio-pci,host=06:00.2 \
        -device vfio-pci,host=06:00.3 \
        -drive if=pflash,file=/usr/share/ovmf/OVMF.fd,format=raw,readonly \
        -boot once=d</script></code></pre>
          </section>
          <section>
            <h2>(虚拟)磁盘？</h2>
            <p>推荐使用 <code>virtio-scsi</code> 来将 host 上的块设备传给虚拟机</p>
            <pre><code><script type="text/template">VIRTIO_SCSI_ARGS="discard=unmap,cache=none,aio=io_uring"
qemu-system-x86_64 \
        -drive if=none,file=/dev/some/block/device,format=raw,id=gentoo,$VIRTIO_SCSI_ARGS -device scsi-hd,drive=gentoo \
        ...</script></code></pre>
          </section>
          <section>
            <h2>网络？</h2>
            <p>推荐使用 <code>virtio</code></p>
            <pre><code><script type="text/template">VIRTIO_NET_ARGS="script=no,downscript=no,vhost=on"
qemu-system-x86_64 \
        -netdev tap,id=tap-gentoo,ifname=tap-gentoo,$VIRTIO_NET_ARGS -net nic,model=virtio,netdev=tap-gentoo \
        ...</script></code></pre>
          </section>
          <section>
            <p>host 上配套的 <cdoe>systemd-networkd</cdoe> 配置</p>
            <pre><code><script type="text/template"># cat /etc/systemd/network/tap-gentoo.network
[Match]
Name=tap-gentoo

[Network]
Bridge=brlan
# cat /etc/systemd/network/tap-gentoo.netdev
[NetDev]
Name=tap-gentoo
Kind=tap</script></code></pre>
          </section>
          <section>
            <h2>输入设备？</h2>
            <h3>方案一: 使用 <code>evdev</code></h3>
            <pre><code><script type="text/template">qemu-system-x86_64 \
        -object input-linux,id=mouse,evdev=/dev/input/by-id/usb-Razer_Razer_DeathAdder_Essential-event-mouse \
        -object input-linux,id=kbd,evdev=/dev/input/by-id/usb-04d9_USB-HID_Keyboard-event-kbd,grab_all=on,repeat=on \
        ...</script></code></pre>
          </section>
          <section>
            <h3>方案二: 使用 USB passthrough</h3>
            <p>AMD Ryzen™ 有 CPU 提供的 USB 接口，可以 PCIe 直通给虚拟机使用</p>
            <pre><code><script type="text/template">08:00.3 USB controller: Advanced Micro Devices, Inc. [AMD] Matisse USB 3.0 Host Controller
        Subsystem: ASRock Incorporation Matisse USB 3.0 Host Controller
        Kernel driver in use: vfio-pci
        Kernel modules: xhci_pci</script></code></pre>
          </section>
          <section>
            <h2>声音？</h2>
            <ul>
              <li>方案一: <a href="https://github.com/duncanthrax/scream">scream</a></li>
              <li>方案二: 配置 USB 直通，使用 USB DAC 设备或 USB 蓝牙适配器连接蓝牙耳机</li>
            </ul>
          </section>
          <section>
            <h2>内存大页？</h2>
            <ul>
              <li><code>qemu</code> 在开启了透明大页支持的系统中，会自动通过 <code>madvice</code> 使用 2MiB 的大页</li>
              <li>也可以手动配置 1GiB 的大页
              </li>
            </ul>
            <p>通过 grub 添加 <code>hugepagesz=1G hugepages=48</code> 内核选项</p>
            <pre><code><script type="text/template"># cat /etc/fstab
hugetlbfs /dev/hugepages hugetlbfs mode=1770,gid=2021,pagesize=1G 0 0</script></code></pre>
            <pre><code><script type="text/template">qemu-system-x86_64 \
        -mem-path /dev/hugepages \
        ...</script></code></pre>
          </section>
          <section>
            <h2>虚拟机安装要点</h2>
          </section>
          <section>
            <p>对于 Windows 虚拟机，如果使用了 virtio 设备，请准备好 virtio 的驱动盘镜像，并在安装时挂载到虚拟 CDROM</p>
            <pre><code><script type="text/template">qemu-system-x86_64 \
        -drive file=/path/to/virtio-win.iso,index=1,media=cdrom \
        ...</script></code></pre>
          </section>
          <section>
            <p>如果磁盘是 thin allocation 的，可以注意匹配一下虚拟机文件系统的 allocation unit 和 thin allocation unit，以及开启 TRIM</p>
            <ul>
              <li>对于 NTFS，可以支持上至 2MiB 的 allocation unit</li>
              <li>对于 XFS 等 Linux 下的文件系统，通常有 RAID stripe width 相关选项
                <p>例如 XFS 的 <code>sunit=128,swidth=128</code></p>
              </li>
            </ul>
          </section>
          <section>
            <h2><a href="https://github.com/gnif/LookingGlass">Looking Glass</a></h2>
            <p>解决的问题: 在有第二个显卡的情况下(例如核显)，使用这张显卡输出 Windows 虚拟机画面</p>
          </section>
          <section>
            <img class="r-stretch" src="lookingglass1.jpg">
            <img class="r-stretch" src="lookingglass2.jpg">
          </section>
        </section>
        <section>
          <h1>THE END</h1>
        </section>
			</div>
		</div>
<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
        history: true,
        progress: true,
        slideNumber: true,
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
